"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.resolveDIDDocumentAuth = exports.validateDIDDocumentAuth = exports.buildVerifierId = exports.isGenesisState = void 0;
const js_crypto_1 = require("@iden3/js-crypto");
const js_iden3_core_1 = require("@iden3/js-iden3-core");
const js_merkletree_1 = require("@iden3/js-merkletree");
/**
 * Checks if state is genesis state
 *
 * @param {string} did - did
 * @param {bigint|string} state  - hash on bigInt or hex string format
 * @returns boolean
 */
function isGenesisState(did, state) {
    if (typeof state === 'string') {
        state = js_merkletree_1.Hash.fromHex(state).bigInt();
    }
    const id = js_iden3_core_1.DID.idFromDID(did);
    const { method, blockchain, networkId } = js_iden3_core_1.DID.decodePartsFromId(id);
    const type = (0, js_iden3_core_1.buildDIDType)(method, blockchain, networkId);
    const idFromState = js_iden3_core_1.Id.idGenesisFromIdenState(type, state);
    return id.bigInt().toString() === idFromState.bigInt().toString();
}
exports.isGenesisState = isGenesisState;
const buildVerifierId = (address, info) => {
    address = address.replace('0x', '');
    const ethAddrBytes = js_crypto_1.Hex.decodeString(address);
    const ethAddr = ethAddrBytes.slice(0, 20);
    const genesis = (0, js_iden3_core_1.genesisFromEthAddress)(ethAddr);
    const tp = (0, js_iden3_core_1.buildDIDType)(info.method, info.blockchain, info.networkId);
    return new js_iden3_core_1.Id(tp, genesis);
};
exports.buildVerifierId = buildVerifierId;
const validateDIDDocumentAuth = async (did, resolverURL, state) => {
    const vm = await (0, exports.resolveDIDDocumentAuth)(did, resolverURL, state);
    if (!vm) {
        throw new Error(`can't resolve DID document`);
    }
    // published or genesis
    if (!vm.published &&
        !isGenesisState(did, state.bigInt())) {
        throw new Error(`issuer state not published and not genesis`);
    }
};
exports.validateDIDDocumentAuth = validateDIDDocumentAuth;
const resolveDIDDocumentAuth = async (did, resolveURL, state) => {
    let url = `${resolveURL}/${did.string().replace(/:/g, '%3A')}`;
    if (state) {
        url += `?state=${state.hex()}`;
    }
    const resp = await fetch(url);
    const didResolutionRes = (await resp.json());
    return didResolutionRes.didDocument?.verificationMethod?.find((i) => i.type === 'Iden3StateInfo2023');
};
exports.resolveDIDDocumentAuth = resolveDIDDocumentAuth;
